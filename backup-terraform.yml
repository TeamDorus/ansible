---
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
#
#       D E V S Y S  -   T E R R A F O R M    S T A T E    F I L E S
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
- name: Playbook to backup terrafrom state files from development system
  hosts:
    - tags_devsys_workstation

  vars_files:
    - vars/backup.yml


  tasks:

    - name: Define the terraform directory with state files
      set_fact:
        state_dir: "/home/eric/Documents/terraform/setups"


    - name: Ensure that the remote backup folder exists
      file:
        path: "{{ remote_backup_folder }}"
        state: directory


    - name: Define the backup filename
      set_fact:
        backup_file: "terraform-{{ ansible_date_time.date }}.tgz"


    - name: Create backup
      archive:
        path:
          - "{{ state_dir }}/*/terraform*"
        dest: "{{ remote_backup_folder }}/{{ backup_file }}"


    - name: Define the local backup folder
      set_fact:
        local_backup_folder: "{{ local_backup_root }}/{{ ansible_hostname }}"


    - name: Fetch backup from remote host
      fetch:
        src: "{{ remote_backup_folder }}/{{ backup_file }}"
        dest: "{{ local_backup_folder }}/"
        flat: true


    - name: Delete backup file on remote host
      file:
        path: "{{ remote_backup_folder }}/{{ backup_file }}"
        state: absent
